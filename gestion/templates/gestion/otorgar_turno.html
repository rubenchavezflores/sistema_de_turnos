{% extends 'gestion/base.html' %}
{% load static %}

{% block extra_css %}
<style>
  .scale-40 {
    transform: scale(0.4);
    transform-origin: top left;
  }

  .input-group.dni-busqueda {
    max-width: 130px;
    position: relative;
  }

  .input-group.dni-busqueda input[type="text"] {
    width: 100%;
    padding-right: 2.5rem;
    box-sizing: border-box;
  }

  .input-group.dni-busqueda button {
    position: absolute;
    right: 0;
    top: 0;
    height: 100%;
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
    padding: 0 0.6rem;
    z-index: 2;
    font-size: 0.9rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <h2>Otorgar Turno: {{ medico.apellido|upper }}, {{ medico.nombre|title }} - {{ medico.especialidad.nombre|upper }}</h2>

  {% if dni_no_existe %}
  <div class="alert alert-danger">No existe paciente con ese DNI.</div>
  {% endif %}

  {% if dias_mostrados %}
  <div class="mb-4">
    <h4>D√≠as de atenci√≥n detallados:</h4>
    <ul>
      {% for d in dias_mostrados %}
      <li>{{ d.dia }}: de {{ d.horario_inicio }} a {{ d.horario_fin }} hs (cada {{ d.intervalo }} min)</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <div class="row">
    <div class="col-md-5 scale-40">
      <div class="card">
        <div class="card-header text-center">
          <h5>Calendario de {{ mes }}/{{ anio }}</h5>
          <div class="btn-group mb-2" role="group">
            <a href="?mes={{ mes_anterior }}&anio={{ anio_anterior }}{% if dni %}&dni={{ dni }}{% endif %}" class="btn btn-secondary btn-sm">¬´ Anterior</a>
            <a href="?mes={{ mes_siguiente }}&anio={{ anio_siguiente }}{% if dni %}&dni={{ dni }}{% endif %}" class="btn btn-secondary btn-sm">Siguiente ¬ª</a>
          </div>
        </div>
        <div class="card-body p-2">
          <div class="row text-center mb-1">
            {% for d in "LMXJVSD" %}
            <div class="col"><small class="text-muted fw-bold">{{ d }}</small></div>
            {% endfor %}
          </div>
          {% for dia in calendario %}
          {% if forloop.counter0|divisibleby:7 %}<div class="row text-center mb-1">{% endif %}
            <div class="col p-1">
              {% if dia.es_del_mes %}
              {% if dia.es_no_laborable %}
              <div class="d-flex align-items-center justify-content-center bg-danger text-white rounded" style="height: 30px;" title="No laborable">{{ dia.fecha.day }}</div>
              {% elif dia.atiende %}
              <a href="?mes={{ mes }}&anio={{ anio }}&fecha={{ dia.fecha|date:'Y-m-d' }}{% if dni %}&dni={{ dni }}{% endif %}" class="btn btn-outline-primary w-100" style="height:30px;">{{ dia.fecha.day }}</a>
              {% else %}
              <div class="d-flex align-items-center justify-content-center text-muted" style="height:30px;">{{ dia.fecha.day }}</div>
              {% endif %}
              {% else %}
              <div class="d-flex align-items-center justify-content-center text-muted" style="height:30px;opacity:0.4;">{{ dia.fecha.day }}</div>
              {% endif %}
            </div>
          {% if forloop.counter|divisibleby:7 or forloop.last %}</div>{% endif %}
          {% endfor %}
        </div>
        <div class="card-footer text-muted" style="font-size: 0.8rem;">
          <span class="badge bg-outline-primary me-2" style="border:1px solid#0d6efd;">‚óè</span>D√≠as disponibles
          {% if fecha_seleccionada %}<br><span class="badge bg-primary me-2">‚óè</span>D√≠a seleccionado{% endif %}
        </div>
      </div>
    </div>

    {% if fecha_seleccionada %}
    <div class="col-md-7 scale-40">
      <div class="card">
        <div class="card-header">
          <h4 class="mb-0" style="font-size:1.2rem;">Turnos del d√≠a {{ fecha_seleccionada|date:"d/m/Y" }}</h4>
        </div>
        <div class="card-body p-2">
          <div class="table-responsive">
            <table class="table table-bordered text-center align-middle" style="font-size: 0.85rem;">
              <thead class="table-light">
                <tr>
                  <th>üïí</th>
                  <th>Buscar DNI</th>
                  <th>Apellido</th>
                  <th>Nombre</th>
                  <th>Sexo</th>
                  <th>Edad</th>
                  <th>Obra Social</th>
                  <th>Localidad</th>
                  <th>Acci√≥n</th>
                </tr>
              </thead>
              <tbody>
                {% for fila in matriz_turnos %}
                <tr>
                  <td>{{ fila.hora }}</td>
                  {% if fila.ocupado %}
                  <td colspan="8"><span class="badge bg-danger">Ocupado</span></td>
                  {% elif hora_busqueda == fila.hora and paciente %}
                  <td><button class="btn btn-sm btn-outline-secondary" disabled>üîç</button></td>
                  <td>{{ paciente.apellido }}</td>
                  <td>{{ paciente.nombre }}</td>
                  <td>{{ paciente.sexo }}</td>
                  <td>{{ paciente.edad }}</td>
                  <td>{{ paciente.obra_social }}</td>
                  <td>{{ paciente.localidad }}</td>
                  <td>
                    <form method="post">
                      {% csrf_token %}
                      <input type="hidden" name="accion" value="reservar_turno">
                      <input type="hidden" name="fecha" value="{{ fecha_seleccionada }}">
                      <input type="hidden" name="hora" value="{{ fila.hora }}">
                      <input type="hidden" name="dni" value="{{ paciente.dni }}">
                      <button type="submit" class="btn btn-sm btn-success">‚úì</button>
                    </form>
                  </td>
                  {% else %}
                  <td>
                    <form class="dni-busqueda d-flex justify-content-center" onsubmit="return buscarPaciente(event, this)">
                      <input type="hidden" name="mes" value="{{ mes }}">
                      <input type="hidden" name="anio" value="{{ anio }}">
                      <input type="hidden" name="fecha" value="{{ fecha_seleccionada }}">
                      <input type="hidden" name="hora_busqueda" value="{{ fila.hora }}">
                      <input type="text" name="dni" class="form-control form-control-sm" placeholder="DNI" maxlength="8" pattern="[0-9]{7,8}" required title="Ingrese 7 u 8 d√≠gitos num√©ricos" value="{{ dni|default:'' }}">
                      <button class="btn btn-outline-primary btn-sm" type="submit">üîç</button>
                    </form>
                  </td>
                  <td class="apellido text-muted"></td>
                  <td class="nombre text-muted"></td>
                  <td class="sexo text-muted"></td>
                  <td class="edad text-muted"></td>
                  <td class="obra-social text-muted"></td>
                  <td class="localidad text-muted"></td>
                  <td class="accion text-muted" style="font-size: 0.8rem;">Primero busc√° al paciente</td>
                  {% endif %}
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  <script>
    const urlBuscarPaciente = "{% url 'buscar_paciente_ajax' %}";

    async function buscarPaciente(event, form) {
      event.preventDefault();

      const dni = form.querySelector('input[name="dni"]').value.trim();
      if (!dni.match(/^\d{7,8}$/)) {
        alert('Por favor, ingrese un DNI v√°lido (7 u 8 d√≠gitos num√©ricos).');
        return false;
      }

      try {
        const response = await fetch(`${urlBuscarPaciente}?dni=${dni}`);
        if (!response.ok) throw new Error('Error en la respuesta de la b√∫squeda');

        const data = await response.json();
        const fila = form.closest('tr');

        if (data.existe) {
          fila.querySelector('.apellido').textContent = data.apellido;
          fila.querySelector('.nombre').textContent = data.nombre;
          fila.querySelector('.sexo').textContent = data.sexo;
          fila.querySelector('.edad').textContent = calculaEdad(data.fecha_nacimiento);
          fila.querySelector('.obra-social').textContent = data.obra_social;
          fila.querySelector('.localidad').textContent = data.localidad || '';
          fila.querySelector('.accion').innerHTML = `
            <form method="post">
              <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
              <input type="hidden" name="accion" value="reservar_turno">
              <input type="hidden" name="fecha" value="${form.querySelector('input[name="fecha"]').value}">
              <input type="hidden" name="hora" value="${form.querySelector('input[name="hora_busqueda"]').value}">
              <input type="hidden" name="dni" value="${dni}">
              <button type="submit" class="btn btn-sm btn-success">‚úì</button>
            </form>`;
        } else {
          alert('No existe paciente con ese DNI.');
          for (let i = 3; i <= 8; i++) {
            fila.querySelector(`td:nth-child(${i})`).textContent = '';
          }
        }

      } catch (error) {
        console.error('Error buscando paciente:', error);
        alert('Error al buscar paciente, int√©ntelo m√°s tarde.');
      }

      return false;
    }

    function calculaEdad(fechaNac) {
      const hoy = new Date();
      const nac = new Date(fechaNac);
      let edad = hoy.getFullYear() - nac.getFullYear();
      const mes = hoy.getMonth() - nac.getMonth();
      if (mes < 0 || (mes === 0 && hoy.getDate() < nac.getDate())) {
        edad--;
      }
      return edad;
    }
  </script>
</div>
{% endblock %}
