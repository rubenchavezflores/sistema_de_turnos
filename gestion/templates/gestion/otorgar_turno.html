{% extends 'gestion/base.html' %}
{% load static %}

{% block extra_css %}
<style>
  /* Escalado para vistas reducidas */
  .scale-40 {
    transform: scale(0.4);
    transform-origin: top left;
  }

  /* Grupo de entrada para b√∫squeda por DNI */
  .input-group.dni-busqueda {
    max-width: 130px;
    position: relative;
  }

  .input-group.dni-busqueda input[type="text"] {
    width: 100%;
    padding-right: 2.5rem;
    box-sizing: border-box;
  }

  .input-group.dni-busqueda button {
    position: absolute;
    right: 0;
    top: 0;
    height: 100%;
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
    padding: 0 0.6rem;
    z-index: 2;
    font-size: 0.9rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">

  <h2>Otorgar Turno: {{ medico.apellido|upper }}, {{ medico.nombre|title }} - {{ medico.especialidad.nombre|upper }}</h2>

  {% if dni_no_existe %}
  <div class="alert alert-danger">No existe paciente con ese DNI.</div>
  {% endif %}

  {% if dias_mostrados %}
  <div class="mb-4">
    <h4>D√≠as de atenci√≥n detallados:</h4>
    <ul>
      {% for d in dias_mostrados %}
      <li>{{ d.dia }}: de {{ d.horario_inicio }} a {{ d.horario_fin }} hs (cada {{ d.intervalo }} min)</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <div class="row">

    <!-- Calendario -->
    <div class="col-md-5 scale-40">
      <div class="card">
        <div class="card-header text-center">
          <h5>Calendario de {{ mes }}/{{ anio }}</h5>
          <div class="btn-group mb-2" role="group">
            <a href="?mes={{ mes_anterior }}&anio={{ anio_anterior }}{% if dni %}&dni={{ dni }}{% endif %}" class="btn btn-secondary btn-sm">¬´ Anterior</a>
            <a href="?mes={{ mes_siguiente }}&anio={{ anio_siguiente }}{% if dni %}&dni={{ dni }}{% endif %}" class="btn btn-secondary btn-sm">Siguiente ¬ª</a>
          </div>
        </div>
        <div class="card-body p-2">

          <div class="row text-center mb-1">
            {% for d in "LMXJVSD" %}
            <div class="col"><small class="text-muted fw-bold">{{ d }}</small></div>
            {% endfor %}
          </div>

          {% for dia in calendario %}
            {% if forloop.counter0|divisibleby:7 %}
            <div class="row text-center mb-1">
            {% endif %}

            <div class="col p-1">
              {% if dia.es_del_mes %}
                {% if dia.es_no_laborable %}
                <div class="d-flex align-items-center justify-content-center bg-danger text-white rounded" style="height: 30px;" title="No laborable">{{ dia.fecha.day }}</div>
                {% elif dia.atiende %}
                <a href="?mes={{ mes }}&anio={{ anio }}&fecha={{ dia.fecha|date:'Y-m-d' }}{% if dni %}&dni={{ dni }}{% endif %}" class="btn btn-outline-primary w-100" style="height:30px;">{{ dia.fecha.day }}</a>
                {% else %}
                <div class="d-flex align-items-center justify-content-center text-muted" style="height:30px;">{{ dia.fecha.day }}</div>
                {% endif %}
              {% else %}
              <div class="d-flex align-items-center justify-content-center text-muted" style="height:30px;opacity:0.4;">{{ dia.fecha.day }}</div>
              {% endif %}
            </div>

            {% if forloop.counter|divisibleby:7 or forloop.last %}
            </div>
            {% endif %}
          {% endfor %}

        </div>
        <div class="card-footer text-muted" style="font-size: 0.8rem;">
          <span class="badge bg-outline-primary me-2" style="border:1px solid #0d6efd;">‚óè</span>D√≠as disponibles
          {% if fecha_seleccionada %}
          <br><span class="badge bg-primary me-2">‚óè</span>D√≠a seleccionado
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Turnos del d√≠a -->
    {% if fecha_seleccionada %}
    <div class="col-md-7 scale-40">
      <div class="card">
        <div class="card-header">
          <h4 class="mb-0" style="font-size:1.2rem;">Turnos del d√≠a {{ fecha_seleccionada|date:"d/m/Y" }}</h4>
        </div>
        <div class="card-body p-2">
          <div class="table-responsive">
            <table class="table table-bordered text-center align-middle" style="font-size: 0.85rem;">
              <thead class="table-light">
                <tr>
                  <th>üïí</th>
                  <th>Buscar DNI</th>
                  <th>Apellido</th>
                  <th>Nombre</th>
                  <th>Sexo</th>
                  <th>Edad</th>
                  <th>Obra Social</th>
                  <th>Localidad</th>
                  <th>Acci√≥n</th>
                </tr>
              </thead>
              <tbody>
                {% for fila in matriz_turnos %}
                <tr>
                  <td>{{ fila.hora }}</td>
                  {% if fila.ocupado %}
<td class="text-dark">{{ fila.dni }}</td>
<td class="text-dark">{{ fila.apellido }}</td>
<td class="text-dark">{{ fila.nombre }}</td>
<td class="text-dark">{{ fila.sexo }}</td>
<td class="text-dark">{{ fila.edad }}</td>
<td class="text-dark">{{ fila.obra_social }}</td>
<td class="text-dark">{{ fila.localidad }}</td>
<td><span class="badge bg-danger">Ocupado</span></td>
                  {% else %}
                    <td>
                      <form class="dni-busqueda d-flex justify-content-center" onsubmit="return buscarPaciente(event, this)">
                        <input type="hidden" name="fecha" value="{{ fecha_seleccionada }}">
                        <input type="hidden" name="hora_busqueda" value="{{ fila.hora }}">
                        <input type="hidden" name="medico_id" value="{{ medico.id }}">
                        <input type="text" name="dni" class="form-control form-control-sm" placeholder="DNI" maxlength="8" pattern="[0-9]{7,8}" required>
                        <button class="btn btn-outline-primary btn-sm" type="submit">üîç</button>
                      </form>
                    </td>
                    <td class="apellido text-muted"></td>
                    <td class="nombre text-muted"></td>
                    <td class="sexo text-muted"></td>
                    <td class="edad text-muted"></td>
                    <td class="obra-social text-muted"></td>
                    <td class="localidad text-muted"></td>
                    <td class="accion text-muted" style="font-size: 0.8rem;">Disponible</td>
                  {% endif %}
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  <script>
    const urlBuscarPaciente = "{% url 'buscar_paciente_ajax' %}";
const urlGuardarTurno = "{% url 'guardar_turno' %}";

// Objeto para almacenar los datos de turnos asignados
let turnosAsignados = {};

function calculaEdad(fecha_nacimiento) {
  const hoy = new Date();
  const nacimiento = new Date(fecha_nacimiento);
  let edad = hoy.getFullYear() - nacimiento.getFullYear();
  const m = hoy.getMonth() - nacimiento.getMonth();
  if (m < 0 || (m === 0 && hoy.getDate() < nacimiento.getDate())) {
    edad--;
  }
  return edad;
}

function esFechaPasada(fechaStr) {
  const fecha = new Date(fechaStr);
  const hoy = new Date();
  hoy.setHours(0, 0, 0, 0);
  return fecha < hoy;
}

// Funci√≥n para generar una clave √∫nica para cada turno
function generarClaveTurno(fecha, hora, medicoId) {
  return `${fecha}_${hora}_${medicoId}`;
}

// Funci√≥n para guardar los datos del turno en memoria
function guardarDatosTurno(fecha, hora, medicoId, datosPaciente) {
  const clave = generarClaveTurno(fecha, hora, medicoId);
  turnosAsignados[clave] = datosPaciente;
}

// Funci√≥n para recuperar los datos del turno desde memoria
function recuperarDatosTurno(fecha, hora, medicoId) {
  const clave = generarClaveTurno(fecha, hora, medicoId);
  return turnosAsignados[clave] || null;
}

// Funci√≥n para eliminar un turno de la memoria
function eliminarTurno(fecha, hora, medicoId) {
  const clave = generarClaveTurno(fecha, hora, medicoId);
  delete turnosAsignados[clave];
}

// Funci√≥n para restaurar los datos de un turno en una fila
function restaurarDatosTurno(fila) {
  const form = fila.querySelector('form');
  if (!form) return false;
  
  const fechaInput = form.querySelector('input[name="fecha"]');
  const horaInput = form.querySelector('input[name="hora_busqueda"]');
  const medicoInput = form.querySelector('input[name="medico_id"]');
  
  if (!fechaInput || !horaInput || !medicoInput) return false;
  
  const fechaRaw = fechaInput.value;
  const hora = horaInput.value;
  const medicoId = medicoInput.value;
  
  const datosGuardados = recuperarDatosTurno(fechaRaw, hora, medicoId);
  
  if (datosGuardados) {
    // Restaurar los datos del paciente
    const apellidoEl = fila.querySelector('.apellido');
    const nombreEl = fila.querySelector('.nombre');
    const sexoEl = fila.querySelector('.sexo');
    const edadEl = fila.querySelector('.edad');
    const obraSocialEl = fila.querySelector('.obra-social');
    const localidadEl = fila.querySelector('.localidad');
    const accionEl = fila.querySelector('.accion');
    
    if (apellidoEl) apellidoEl.textContent = datosGuardados.apellido;
    if (nombreEl) nombreEl.textContent = datosGuardados.nombre;
    if (sexoEl) sexoEl.textContent = datosGuardados.sexo;
    if (edadEl) edadEl.textContent = datosGuardados.edad;
    if (obraSocialEl) obraSocialEl.textContent = datosGuardados.obra_social;
    if (localidadEl) localidadEl.textContent = datosGuardados.localidad;
    
    if (accionEl) {
      accionEl.innerHTML = `<span class="badge bg-danger">Ocupado</span>`;
    }
    
    return true;
  }
  
  return false;
}

async function buscarPaciente(event, form) {
  event.preventDefault();

  const dni = form.querySelector('input[name="dni"]').value.trim();
  if (!dni.match(/^\d{7,8}$/)) {
    alert('Por favor, ingrese un DNI v√°lido (7 u 8 d√≠gitos num√©ricos).');
    return false;
  }

  try {
    const response = await fetch(`${urlBuscarPaciente}?dni=${dni}`);
    if (!response.ok) throw new Error('Error en la b√∫squeda del paciente');
    const data = await response.json();
    const fila = form.closest('tr');

    if (data.existe) {
      // Actualizar los datos del paciente
      fila.querySelector('.apellido').textContent = data.apellido;
      fila.querySelector('.nombre').textContent = data.nombre;
      fila.querySelector('.sexo').textContent = data.sexo;
      fila.querySelector('.edad').textContent = calculaEdad(data.fecha_nacimiento);
      fila.querySelector('.obra-social').textContent = data.obra_social;
      fila.querySelector('.localidad').textContent = data.localidad;

      const fechaRaw = form.querySelector('input[name="fecha"]').value;
      const hora = form.querySelector('input[name="hora_busqueda"]').value;
      const medicoId = form.querySelector('input[name="medico_id"]').value;

      // Mostrar botones de guardar y cancelar
      fila.querySelector('.accion').innerHTML = `
        <button class="btn btn-sm btn-success me-2" onclick="guardarTurno(this, ${data.id}, '${fechaRaw}', '${hora}', '${medicoId}')">Guardar</button>
        <button class="btn btn-sm btn-secondary" onclick="cancelarAsignacion(this)">Cancelar</button>
      `;

    } else {
      alert("Paciente no encontrado. Debe registrarlo primero.");
      form.querySelector('input[name="dni"]').value = '';
    }

  } catch (error) {
    console.error("Error:", error);
    alert("Ocurri√≥ un error al buscar el paciente.");
  }
}

// Funci√≥n para guardar el turno
async function guardarTurno(boton, pacienteId, fechaRaw, hora, medicoId) {
  const fila = boton.closest('tr');
  
  const fechaObj = new Date(fechaRaw);
  const fechaFormateada = fechaObj.toISOString().split('T')[0];

  if (esFechaPasada(fechaFormateada)) {
    alert("No se puede asignar un turno en una fecha pasada.");
    return;
  }

  try {
    const resp = await fetch(urlGuardarTurno, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({
        fecha: fechaFormateada,
        hora: hora,
        medico: medicoId,
        paciente: pacienteId
      })
    });

    if (resp.ok) {
      // Guardar los datos del turno en memoria para persistencia
      const datosTurno = {
        apellido: fila.querySelector('.apellido').textContent,
        nombre: fila.querySelector('.nombre').textContent,
        sexo: fila.querySelector('.sexo').textContent,
        edad: fila.querySelector('.edad').textContent,
        obra_social: fila.querySelector('.obra-social').textContent,
        localidad: fila.querySelector('.localidad').textContent,
        pacienteId: pacienteId
      };
      
      guardarDatosTurno(fechaRaw, hora, medicoId, datosTurno);
      
      // Mostrar estado ocupado
      fila.querySelector('.accion').innerHTML = `
        <span class="badge bg-danger">Ocupado</span>
      `;
      
    } else {
      alert("Error al guardar el turno.");
    }
  } catch (error) {
    console.error("Error al guardar:", error);
    alert("Error al guardar el turno.");
  }
}

// Funci√≥n para cancelar la asignaci√≥n
function cancelarAsignacion(boton) {
  const fila = boton.closest('tr');
  const form = fila.querySelector('form');
  
  // Si hab√≠a un turno guardado, eliminarlo de la memoria
  if (form) {
    const fechaRaw = form.querySelector('input[name="fecha"]').value;
    const hora = form.querySelector('input[name="hora_busqueda"]').value;
    const medicoId = form.querySelector('input[name="medico_id"]').value;
    
    eliminarTurno(fechaRaw, hora, medicoId);
  }
  
  // Limpiar toda la fila
  limpiarFilaCompleta(fila);
}

// Funci√≥n para limpiar completamente una fila
function limpiarFilaCompleta(fila) {
  const apellidoEl = fila.querySelector('.apellido');
  const nombreEl = fila.querySelector('.nombre');
  const sexoEl = fila.querySelector('.sexo');
  const edadEl = fila.querySelector('.edad');
  const obraSocialEl = fila.querySelector('.obra-social');
  const localidadEl = fila.querySelector('.localidad');
  const accionEl = fila.querySelector('.accion');
  const form = fila.querySelector('form');
  
  if (apellidoEl) apellidoEl.textContent = '';
  if (nombreEl) nombreEl.textContent = '';
  if (sexoEl) sexoEl.textContent = '';
  if (edadEl) edadEl.textContent = '';
  if (obraSocialEl) obraSocialEl.textContent = '';
  if (localidadEl) localidadEl.textContent = '';
  
  if (form) {
    const dniInput = form.querySelector('input[name="dni"]');
    if (dniInput) dniInput.value = '';
  }
  
  if (accionEl) {
    accionEl.innerHTML = `<span class="text-muted">Disponible</span>`;
  }
}

// Funci√≥n para restaurar todos los turnos al cargar la p√°gina
function restaurarTurnos() {
  const filas = document.querySelectorAll('tr');
  filas.forEach(fila => {
    const form = fila.querySelector('form');
    if (form) {
      restaurarDatosTurno(fila);
    }
  });
}
  </script>
<script>
  // Ejecutar despu√©s de que se cargue todo
  setTimeout(function() {
    restaurarTurnos();
  }, 500);
</script>
</div>
{% endblock %}
